\documentclass[10pt,a4paper,landscape]{extbook}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}
\usepackage{graphicx}
\usepackage{amsfonts,amssymb,amscd,amsmath}
\usepackage[left=0.5cm, right=0.5cm, top=2.7cm, bottom=2cm]{geometry}
\usepackage{tikz}
\usetikzlibrary{arrows,positioning}

\begin{document}

\tikzstyle{block} = [draw, fill=blue!20, rectangle, minimum height=2em]
\tikzstyle{sum} = [draw, fill=blue!20, circle]
\tikzstyle{output} = [coordinate]
\tikzstyle{pinstyle} = [pin edge={to-,thin,black}]


\begin{tikzpicture}[auto, node distance=2cm,>=latex']

	\node [sum] (startStep) {};

	\node [sum, right of=startStep, node distance=1.5cm] (startStage) {};

	\node [block, right of=startStage, node distance=3cm] (cpuPrepare) {CPU prepare};
	\node [block, above of=cpuPrepare, node distance=2cm] (gpu1Prepare) {GPU1 prepare};
	\node [block, above of=gpu1Prepare, node distance=2cm] (gpu2Prepare) {GPU2 prepare};
	\node [block, above of=gpu2Prepare, node distance=2cm] (gpu3Prepare) {GPU3 prepare};

	\node [sum, right of=cpuPrepare, pin={[pinstyle]below:Sync}, node distance=2cm] (sync) {};

	\node [output, right of=startStep, node distance=2.5cm] (pr) {};



	\node [block, right of=sync, node distance=3.5cm] (cpuCenter) {CPU compute center};
	\node [block, above of=cpuCenter, node distance=2cm] (gpu1Center) {GPU1 compute center};
	\node [block, above of=gpu1Center, node distance=2cm] (gpu2Center) {GPU2 compute center};
	\node [block, above of=gpu2Center, node distance=2cm] (gpu3Center) {GPU3 compute center};

	\node [block, below of=cpuCenter, node distance=2cm] (sendRecv) {Send / receive};

	\node [output, right of=sync, node distance=1.2cm] (comC) {};



	\node [sum, right of=cpuCenter, pin={[pinstyle]above:Wait}, node distance=2.5cm] (wait) {};

	\node [block, right of=wait, node distance=4cm] (cpuBorder) {CPU compute border};
	\node [block, above of=cpuBorder, node distance=2cm] (gpu1Border) {GPU1 compute border};
	\node [block, above of=gpu1Border, node distance=2cm] (gpu2Border) {GPU2 compute border};
	\node [block, above of=gpu2Border, node distance=2cm] (gpu3Border) {GPU3 compute border};

	\node [output, right of=wait, node distance=1cm] (comB) {};

	\node [block, right of=cpuBorder, node distance=4.5cm] (prepareArgs) {Prepare args};


	\node [sum, right of=prepareArgs, node distance=2.5cm] (stopStage) {};
	\node [block, right of=stopStage, node distance=1.5cm] (swap) {Swap};
	\node [sum, right of=swap, node distance=1.5cm] (stopStep) {};

	\node [output, below of=cpuCenter, node distance=4cm] (tmp1) {};
	\node [output, below of=cpuCenter, node distance=6cm] (tmp2) {};

	%\node [output, below of=wait, node distance=3cm] (output) {};

	\draw [->](startStep) -- (startStage);
	\draw [->](startStage) -- (cpuPrepare);

	\draw [->] (pr) |- (gpu1Prepare);
	\draw [->] (pr) |- (gpu2Prepare);
	\draw [->] (pr) |- (gpu3Prepare);

	\draw [->](cpuPrepare) -- (sync);
	\draw [->](gpu1Prepare) -| (sync);
	\draw [->](gpu2Prepare) -| (sync);
	\draw [->](gpu3Prepare) -| (sync);

	\draw [->](sync) -- (cpuCenter);
	\draw [->] (comC) |- (gpu1Center);
	\draw [->] (comC) |- (gpu2Center);
	\draw [->] (comC) |- (gpu3Center);
	\draw [->] (comC) |- (sendRecv);
	\draw [->] (sendRecv) -| (wait);

	\draw [->](cpuCenter) -- (wait);

	\draw [->](wait) -- (cpuBorder);
	\draw [->] (comB) |- (gpu1Border);
	\draw [->] (comB) |- (gpu2Border);
	\draw [->] (comB) |- (gpu3Border);

	\draw [->](cpuBorder) -- (prepareArgs);

	\draw [->](prepareArgs) -- (stopStage);
	\draw [->](stopStage) -- (swap);
	\draw [->](swap) -- (stopStep);

	\draw [-] (stopStage) |- (tmp1);
	\draw [->] (tmp1) -| (startStage);

	\draw [-] (stopStep) |- (tmp2);
	\draw [->] (tmp2) -| (startStep);

	%\draw [-](wait) -- (output);



	%\draw [->] (stopStage) |- (startStage);

%	\draw [->] (controller) -- node[name=u] {$u$} (system);
%	\node [output, right of=system] (output) {};
%	\node [block, below of=u] (measurements) {Measurements};
%
%
%	\draw [->](step) -- (stage);
%
%	\draw [->] (stage) -- node {$e$} (controller);
%	\draw [->] (system) -- node [name=y] {$y$}(output);
%	\draw [->] (y) |- (measurements);
%	\draw [->] (measurements) -| node[pos=0.99] {$-$} 
%	node [near end] {$y_m$} (stage);
\end{tikzpicture}

\end{document}













































