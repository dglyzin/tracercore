\documentclass[12pt,a4paper,landscape]{extbook}
\usepackage[T2A]{fontenc}
\usepackage[russian]{babel}
\usepackage{graphicx}
\usepackage{amsfonts,amssymb,amscd,amsmath}
\usepackage[left=1.5cm, right=1.5cm, top=2.7cm, bottom=2cm]{geometry}
\usepackage{tikz}
\usetikzlibrary{arrows,positioning}

\begin{document}

\tikzstyle{block} = [draw, fill=green!20, rectangle, minimum height=2em]
\tikzstyle{sum} = [draw, fill=blue!20, circle]
\tikzstyle{output} = [coordinate]
\tikzstyle{pinstyle} = [pin edge={to-,thin,black}]


\begin{tikzpicture}[auto, node distance=2cm,>=latex']

	\node [sum] (startStep) {};

	\node [sum, right of=startStep, node distance=1.5cm] (startStage) {};

	\node [block, right of=startStage, node distance=2.5cm] (cpuPrepare) {CPU};
	\node [block, above of=cpuPrepare, node distance=2cm] (gpu1Prepare) {GPU1};
	\node [block, above of=gpu1Prepare, node distance=2cm] (gpu2Prepare) {GPU2};
	\node [block, above of=gpu2Prepare, node distance=2cm] (gpu3Prepare) {GPU3};

	\node [block, above of=gpu3Prepare, node distance=1.2cm, fill=red!20] (preapre) {Prepare data};

	\node [output, left of=cpuPrepare, node distance=1.5cm] (pr) {};
	\node [sum, right of=cpuPrepare, pin={[pinstyle]below:Sync}, node distance=1.5cm] (sync) {};



	\node [block, right of=sync, node distance=3.5cm] (cpuCenter) {CPU};
	\node [block, above of=cpuCenter, node distance=2cm] (gpu1Center) {GPU1};
	\node [block, above of=gpu1Center, node distance=2cm] (gpu2Center) {GPU2};
	\node [block, above of=gpu2Center, node distance=2cm] (gpu3Center) {GPU3};

	\node [block, above of=gpu3Center, node distance=1.2cm, fill=red!20] (center) {Compute center};

	\node [block, below of=cpuCenter, node distance=2cm] (sendRecv) {Send/receive};

	\node [output, left of=cpuCenter, node distance=2cm] (comC) {};



	\node [sum, right of=cpuCenter, pin={[pinstyle]above:Wait}, node distance=2cm] (wait) {};

	\node [block, right of=wait, node distance=3cm] (cpuBorder) {CPU};
	\node [block, above of=cpuBorder, node distance=2cm] (gpu1Border) {GPU1};
	\node [block, above of=gpu1Border, node distance=2cm] (gpu2Border) {GPU2};
	\node [block, above of=gpu2Border, node distance=2cm] (gpu3Border) {GPU3};

	\node [block, above of=gpu3Border, node distance=1.2cm, fill=red!20] (border) {Compute border};

	\node [output, left of=cpuBorder, node distance=1.5cm] (comB) {};

	\node [block, right of=cpuBorder, node distance=3.5cm] (prepareArgs) {Prepare args};


	\node [sum, right of=prepareArgs, node distance=2.5cm] (stopStage) {};
	\node [block, right of=stopStage, node distance=1.5cm] (swap) {Swap};
	\node [sum, right of=swap, node distance=1.5cm] (stopStep) {};

	%\node [output, below of=wait, node distance=4cm, pin={[pinstyle]above:Next stage}] (tmp1) {};
	%\node [output, below of=wait, node distance=6cm, pin={[pinstyle]above:Next step}] (tmp2) {};

	\node [block, below of=wait, node distance=4cm, fill=yellow!20] (tmp1) {Next stage};
	\node [block, below of=wait, node distance=6cm, fill=yellow!20] (tmp2) {Next step};

	%\node [output, below of=wait, node distance=3cm] (output) {};

	\draw [->, line width=2](startStep) -- (startStage);
	\draw [->, line width=2](startStage) -- (cpuPrepare);

	\draw [->, line width=2] (pr) |- (gpu1Prepare);
	\draw [->, line width=2] (pr) |- (gpu2Prepare);
	\draw [->, line width=2] (pr) |- (gpu3Prepare);

	\draw [->, line width=2](cpuPrepare) -- (sync);
	\draw [->, line width=2](gpu1Prepare) -| (sync);
	\draw [->, line width=2](gpu2Prepare) -| (sync);
	\draw [->, line width=2](gpu3Prepare) -| (sync);

	\draw [->, line width=2](sync) -- (cpuCenter);
	\draw [->, line width=2] (comC) |- (gpu1Center);
	\draw [->, line width=2] (comC) |- (gpu2Center);
	\draw [->, line width=2] (comC) |- (gpu3Center);
	\draw [->, line width=2] (comC) |- (sendRecv);
	\draw [->, line width=2] (sendRecv) -| (wait);

	\draw [->, line width=2](cpuCenter) -- (wait);

	\draw [->, line width=2](wait) -- (cpuBorder);
	\draw [->, line width=2] (comB) |- (gpu1Border);
	\draw [->, line width=2] (comB) |- (gpu2Border);
	\draw [->, line width=2] (comB) |- (gpu3Border);

	\draw [->, line width=2](cpuBorder) -- (prepareArgs);

	\draw [->, line width=2](prepareArgs) -- (stopStage);
	\draw [->, line width=2](stopStage) -- (swap);
	\draw [->, line width=2](swap) -- (stopStep);

	\draw [-, line width=2] (stopStage) |- (tmp1);
	\draw [->, line width=2] (tmp1) -| (startStage);

	\draw [-, line width=2] (stopStep) |- (tmp2);
	\draw [->, line width=2] (tmp2) -| (startStep);


	\draw [/tikz/dashed, line width=2] (gpu1Center) -- (gpu1Border);
	\draw [/tikz/dashed, line width=2] (gpu2Center) -- (gpu2Border);
	\draw [/tikz/dashed, line width=2] (gpu3Center) -- (gpu3Border);

	%\draw [-](wait) -- (output);



	%\draw [->] (stopStage) |- (startStage);

%	\draw [->] (controller) -- node[name=u] {$u$} (system);
%	\node [output, right of=system] (output) {};
%	\node [block, below of=u] (measurements) {Measurements};
%
%
%	\draw [->](step) -- (stage);
%
%	\draw [->] (stage) -- node {$e$} (controller);
%	\draw [->] (system) -- node [name=y] {$y$}(output);
%	\draw [->] (y) |- (measurements);
%	\draw [->] (measurements) -| node[pos=0.99] {$-$} 
%	node [near end] {$y_m$} (stage);
\end{tikzpicture}

\end{document}













































 
